<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youngbeen.youngService.Mapper.StockInfoMapper">
    <!--    &lt;!&ndash;TODO : ì „ì²´ì ìœ¼ë¡œ ìˆ˜ì •í•„ìš” &ndash;&gt;-->
    <select id="findAll"  resultType="Map">
        SELECT
        SRTNCD,
        ISINCD,
        MRKTCTG,
        ITMSNM,
        CRNO,
        CORPNM,
        BASDT
        FROM
        STOCK_INFO
    </select>

    <!-- ì „ì²´ ì£¼ì‹ ë°ì´í„° ìˆ˜ ì¡°íšŒ -->
    <select id="countAll" resultType="long">
        SELECT COUNT(*) FROM STOCK_INFO
    </select>

    <!-- íŽ˜ì´ì§• ì²˜ë¦¬ëœ ì „ì²´ ì£¼ì‹ ëª©ë¡ ì¡°íšŒ - MySQL LIMIT ì‚¬ìš© -->
    <select id="findAllWithPaging" resultType="Map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        SI.BASDT,
        CASE
        WHEN UFS.FAVORITE_ID IS NOT NULL THEN 'true'
        ELSE 'false'
        END AS IS_FAVORITE
        FROM
        STOCK_INFO SI
        LEFT OUTER JOIN USER_FAVORITE_STOCKS UFS
        ON SI.SRTNCD = UFS.FAVORITE_ID
        and UFS.USER_ID = #{userId}
        ORDER BY SI.ITMSNM
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ì¦ê²¨ì°¾ê¸°ëœ ì£¼ì‹ ëª©ë¡ ì¡°íšŒ -->
    <select id="searchStockfavorites" resultType="Map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        SI.BASDT,
        SP.CLPR,
        SP.VS,
        SP.FLTRT,
        SP.MKP,
        SP.HIPR,
        SP.LOPR,
        SP.TRQU,
        SP.TRPRC,
        SP.LSTGSTCNT,
        SP.MRKTTOTAMT
        FROM
        STOCK_INFO SI
        INNER JOIN USER_FAVORITE_STOCKS UFS
        ON SI.SRTNCD = UFS.FAVORITE_ID
        INNER JOIN STOCK_PRICE SP
        ON SI.ISINCD = SP.ISINCD
        WHERE UFS.USER_ID=#{userId}
        AND SP.BASDT = (SELECT MAX(BASDT) FROM STOCK_PRICE)
    </select>

    <!-- í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ëœ ì£¼ì‹ ë°ì´í„° ìˆ˜ ì¡°íšŒ -->
    <select id="countByKeyword" parameterType="String" resultType="long">
        SELECT COUNT(*)
        FROM STOCK_INFO
        WHERE
        SRTNCD LIKE CONCAT('%', #{keyword}, '%')
        OR ITMSNM LIKE CONCAT('%', #{keyword}, '%')
    </select>

    <!-- íŽ˜ì´ì§• ì²˜ë¦¬ëœ í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ - MySQL LIMIT ì‚¬ìš© -->
    <select id="findByKeywordWithPaging" resultType="Map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        SI.BASDT,
        CASE
        WHEN UFS.FAVORITE_ID IS NOT NULL THEN 'true'
        ELSE 'false'
        END AS IS_FAVORITE
        FROM
        STOCK_INFO SI
        LEFT OUTER JOIN USER_FAVORITE_STOCKS UFS
        ON SI.SRTNCD = UFS.FAVORITE_ID
        AND UFS.USER_ID=#{userId}
        WHERE
        SI.SRTNCD LIKE CONCAT('%', #{keyword}, '%')
        OR SI.ITMSNM LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY SI.ITMSNM
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- MySQL DATE_FORMAT ì‚¬ìš© -->
    <select id="findByStockCode"  parameterType="Map" resultType="Map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        DATE_FORMAT(SP.BASDT, '%Y-%m-%d') AS BASDT,
        SP.CLPR,
        SP.VS,
        SP.FLTRT,
        SP.MKP,
        SP.HIPR,
        SP.LOPR,
        SP.TRQU,
        SP.TRPRC,
        SP.LSTGSTCNT,
        SP.MRKTTOTAMT
        FROM
        STOCK_INFO SI
        INNER JOIN STOCK_PRICE SP
        ON SI.ISINCD = SP.ISINCD
        WHERE
        (SI.SRTNCD LIKE CONCAT('%', #{keyword}, '%')
        OR SI.ITMSNM LIKE CONCAT('%', #{keyword}, '%'))
        AND SP.BASDT = #{basedt}
    </select>

    <select id="searchStockDetails" parameterType="map" resultType="map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        SP.BASDT,
        SP.CLPR,
        SP.VS,
        SP.FLTRT,
        SP.MKP,
        SP.HIPR,
        SP.LOPR,
        SP.TRQU,
        SP.TRPRC,
        SP.LSTGSTCNT,
        SP.MRKTTOTAMT
        FROM
        STOCK_INFO SI
        INNER JOIN STOCK_PRICE SP
        ON SI.ISINCD = SP.ISINCD
        <where>
            <!-- stockCode ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ LIKE ì¡°ê±´ ì ìš© -->
            <if test="stockCode != null and stockCode != ''">
                AND SI.SRTNCD LIKE CONCAT('%', #{stockCode}, '%')
            </if>
            <!-- stockName ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë‘ ì»¬ëŸ¼ì— ëŒ€í•´ LIKE ì¡°ê±´ ì ìš© -->
            <if test="stockName != null and stockName != ''">
                AND (
                SI.ISINCD LIKE CONCAT('%', #{stockName}, '%')
                OR SI.ITMSNM LIKE CONCAT('%', #{stockName}, '%')
                )
            </if>
            <!-- marketType ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë“±ì¹˜ ì¡°ê±´ ì ìš© -->
            <if test="marketType != null and marketType != ''">
                AND SI.MRKTCTG = #{marketType}
            </if>
            <!-- startDate ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ì‹œìž‘ì¼ ì¡°ê±´ ì ìš© -->
            <if test="startDate != null and startDate != ''">
                AND SP.BASDT &gt;= #{startDate}
            </if>
            <!-- endDate ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ì¢…ë£Œì¼ ì¡°ê±´ ì ìš© -->
            <if test="endDate != null and endDate != ''">
                AND SP.BASDT &lt;= #{endDate}
            </if>
            <!-- sector ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë“±ì¹˜ ì¡°ê±´ ì ìš© -->
            <if test="sector != null and sector != ''">
                AND SI.CORPNM = #{sector}
            </if>
        </where>
    </select>

    <!-- ìƒì„¸ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰ëœ ì£¼ì‹ ë°ì´í„° ìˆ˜ ì¡°íšŒ -->
    <select id="countStockDetailsWithConditions" parameterType="map" resultType="long">
        SELECT COUNT(*)
        FROM
        STOCK_INFO SI
        INNER JOIN STOCK_PRICE SP
        ON SI.ISINCD = SP.ISINCD
        <where>
            <!-- stockCode ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ LIKE ì¡°ê±´ ì ìš© -->
            <if test="stockCode != null and stockCode != ''">
                AND SI.SRTNCD LIKE CONCAT('%', #{stockCode}, '%')
            </if>
            <!-- stockName ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë‘ ì»¬ëŸ¼ì— ëŒ€í•´ LIKE ì¡°ê±´ ì ìš© -->
            <if test="stockName != null and stockName != ''">
                AND (
                SI.ISINCD LIKE CONCAT('%', #{stockName}, '%')
                OR SI.ITMSNM LIKE CONCAT('%', #{stockName}, '%')
                )
            </if>
            <!-- marketType ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë“±ì¹˜ ì¡°ê±´ ì ìš© -->
            <if test="marketType != null and marketType != ''">
                AND SI.MRKTCTG = #{marketType}
            </if>
            <!-- startDate ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ì‹œìž‘ì¼ ì¡°ê±´ ì ìš© -->
            <if test="startDate != null and startDate != ''">
                AND SP.BASDT &gt;= #{startDate}
            </if>
            <!-- endDate ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ì¢…ë£Œì¼ ì¡°ê±´ ì ìš© -->
            <if test="endDate != null and endDate != ''">
                AND SP.BASDT &lt;= #{endDate}
            </if>
            <!-- sector ì¡°ê±´: ê°’ì´ ìžˆì„ ë•Œë§Œ ë“±ì¹˜ ì¡°ê±´ ì ìš© -->
            <if test="sector != null and sector != ''">
                AND SI.CORPNM = #{sector}
            </if>
        </where>
    </select>

    <!-- íŽ˜ì´ì§• ì²˜ë¦¬ëœ ìƒì„¸ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ - MySQL LIMIT ì‚¬ìš© -->
    <select id="searchStockDetailsWithPaging" parameterType="map" resultType="map">
        SELECT
        SI.SRTNCD,
        SI.ISINCD,
        SI.MRKTCTG,
        SI.ITMSNM,
        SI.CRNO,
        SI.CORPNM,
        DATE_FORMAT(SP.BASDT,'%Y-%m-%d') as BASDT,
        SP.CLPR,
        SP.VS,
        SP.FLTRT,
        SP.MKP,
        SP.HIPR,
        SP.LOPR,
        SP.TRQU,
        SP.TRPRC,
        SP.LSTGSTCNT,
        SP.MRKTTOTAMT
        FROM
        STOCK_INFO SI
        INNER JOIN STOCK_PRICE SP ON SI.ISINCD = SP.ISINCD
        <where>
            <if test="stockCode != null and stockCode != ''">
                AND SI.SRTNCD LIKE CONCAT('%', #{stockCode}, '%')
            </if>
            <if test="stockName != null and stockName != ''">
                AND (
                SI.ISINCD LIKE CONCAT('%', #{stockName}, '%')
                OR SI.ITMSNM LIKE CONCAT('%', #{stockName}, '%')
                )
            </if>
            <if test="marketType != null and marketType != ''">
                AND SI.MRKTCTG = #{marketType}
            </if>
            <if test="startDate != null and startDate != ''">
                AND SP.BASDT &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND SP.BASDT &lt;= #{endDate}
            </if>
            <if test="sector != null and sector != ''">
                AND SI.CORPNM = #{sector}
            </if>
        </where>
        ORDER BY SP.BASDT DESC, SI.ITMSNM
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ì£¼ì‹ ì„±ê³¼ ë¹„êµ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ - MySQL STR_TO_DATE ì‚¬ìš© -->
    <select id="selcetPerformance" parameterType="map" resultType="map">
        SELECT
            SI.CORPNM AS COMPANY_NAME,
            SI.SRTNCD AS STOCK_CODE,
            SI.MRKTCTG AS MARKET_CATEGORY,
            FIRST_DAY.BASDT AS START_DATE,
            FIRST_DAY.CLPR AS START_PRICE,
            LAST_DAY.BASDT AS END_DATE,
            LAST_DAY.CLPR AS END_PRICE,
            ROUND((LAST_DAY.CLPR - FIRST_DAY.CLPR) / FIRST_DAY.CLPR * 100, 2) AS PRICE_CHANGE_PCT
        FROM STOCK_INFO SI
        INNER JOIN (
            -- ë¨¼ì € MIN/MAX ë‚ ì§œë¥¼ êµ¬í•œ í›„
            SELECT
                sp1.ISINCD,
                sp1.BASDT,
                sp1.CLPR
            FROM STOCK_PRICE sp1
            INNER JOIN (
                SELECT
                    ISINCD,
                    MIN(BASDT) as min_date
                FROM STOCK_PRICE
                WHERE BASDT BETWEEN STR_TO_DATE(#{startDate}, '%Y-%m-%d')
                    AND STR_TO_DATE(#{endDate}, '%Y-%m-%d')
                GROUP BY ISINCD
                ) min_dates ON sp1.ISINCD = min_dates.ISINCD
                            AND sp1.BASDT = min_dates.min_date
            ) FIRST_DAY ON SI.ISINCD = FIRST_DAY.ISINCD
        INNER JOIN (
            SELECT
                sp1.ISINCD,
                sp1.BASDT,
                sp1.CLPR
            FROM STOCK_PRICE sp1
            INNER JOIN (
                SELECT
                    ISINCD,
                    MAX(BASDT) as max_date
                FROM STOCK_PRICE
                WHERE BASDT BETWEEN STR_TO_DATE(#{startDate}, '%Y-%m-%d')
                    AND STR_TO_DATE(#{endDate}, '%Y-%m-%d')
                GROUP BY ISINCD
                ) max_dates ON sp1.ISINCD = max_dates.ISINCD
                            AND sp1.BASDT = max_dates.max_date
            ) LAST_DAY ON SI.ISINCD = LAST_DAY.ISINCD
        WHERE 1=1
        <if test="marketType != null and marketType != 'ALL'">
            AND SI.MRKTCTG = #{marketType}
        </if>
        ORDER BY PRICE_CHANGE_PCT DESC
    </select>

    <select id="countByMarketType"  parameterType="String" resultType="Long">
        SELECT COUNT(1) AS CNT
        FROM STOCK_INFO
        WHERE MRKTCTG = #{MRKTCTG}
    </select>

    <!-- MySQL NOW() í•¨ìˆ˜ ì‚¬ìš© -->
    <insert id="addFavoriteStock" parameterType="Map">
        INSERT INTO USER_FAVORITE_STOCKS (
        FAVORITE_ID,
        USER_ID,
        ADD_DATE
        ) VALUES (
        #{srtnCd},
        #{userId},
        DATE_FORMAT(NOW(), '%Y-%m-%d'))
    </insert>

    <delete id="deleteFavoriteStock" parameterType="Map">
        DELETE FROM USER_FAVORITE_STOCKS
        WHERE
        FAVORITE_ID = #{srtnCd}
        AND USER_ID = #{userId}
    </delete>

    <!-- ðŸ”¥ ëª¨ë“  REMARKSë¥¼ NULLë¡œ ì´ˆê¸°í™” -->
    <update id="resetAllRemarksToNull">
        UPDATE STOCK_PRICE
        SET REMARKS = NULL
        WHERE REMARKS IS NOT NULL
    </update>

    <!-- ðŸ”¥ ë°°ì¹˜ ë‹¨ìœ„ë¡œ REMARKSë¥¼ NULLë¡œ ì´ˆê¸°í™” (MySQL ê¸°ì¤€) -->
    <update id="resetRemarksBatch">
        UPDATE STOCK_PRICE
        SET REMARKS = NULL
        WHERE REMARKS IS NOT NULL
        LIMIT #{batchSize}
    </update>

    <!-- Oracleì¸ ê²½ìš° ROWNUM ì‚¬ìš© -->
    <update id="resetRemarksBatchOracle">
        UPDATE STOCK_PRICE
        SET REMARKS = NULL
        WHERE ROWID IN (
        SELECT ROWID
        FROM STOCK_PRICE
        WHERE REMARKS IS NOT NULL
        AND ROWNUM &lt;= #{batchSize}
        )
    </update>

    <!-- ë” ì •êµí•œ ë°°ì¹˜ ì²˜ë¦¬ (ID ê¸°ë°˜) -->
    <update id="resetRemarksBatchWithId">
        UPDATE STOCK_PRICE
        SET REMARKS = NULL
        WHERE REMARKS IS NOT NULL
        AND ID BETWEEN #{startId} AND #{endId}
    </update>

</mapper>